<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel del Camionero</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1rem;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.2rem;
      font-weight: bold;
      color: #667eea;
    }
    
    main {
      flex: 1;
      padding: 2rem 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }
    
    .panel {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    h2 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }
    
    p {
      color: #666;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      color: #333;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      background: white;
    }
    
    select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    button {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-submit {
      background: #667eea;
      color: white;
      width: auto;
      padding: 0.75rem 1.5rem;
    }
    
    .btn-submit:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-toggle-ubicacion {
      background: #4CAF50;
      color: white;
      margin-top: 1rem;
    }
    
    .btn-toggle-ubicacion:hover {
      background: #45a049;
    }
    
    .btn-toggle-ubicacion.active {
      background: #f44336;
    }
    
    .btn-toggle-ubicacion.active:hover {
      background: #da190b;
    }
    
    .btn-toggle-ubicacion:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      background: #f0f0f0;
      display: none;
    }
    
    .status.active {
      display: block;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .info-box {
      background: #e3f2fd;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border-left: 4px solid #2196F3;
    }

    .info-box strong {
      color: #1976D2;
    }
    
    footer {
      background: rgba(255, 255, 255, 0.95);
      text-align: center;
      padding: 1rem;
      color: #666;
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAh5BW3Yg6pFNfDVynYXcHOiA96G5ZPr2w",
      authDomain: "ecocalendario-51a84.firebaseapp.com",
      databaseURL: "https://ecocalendario-51a84-default-rtdb.firebaseio.com",
      projectId: "ecocalendario-51a84",
      storageBucket: "ecocalendario-51a84.appspot.com",
      messagingSenderId: "276857323066",
      appId: "1:276857323066:web:99b3f8f2e9d0d471d97f03",
      measurementId: "G-VXCZYN6WNC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <header>
    <nav>
      <div class="nav-container">
        <div class="logo">üöõ Panel Camionero</div>
        <button onclick="logout()" class="btn-submit">Cerrar Sesi√≥n</button>
      </div>
    </nav>
  </header>

  <main>
    <div class="panel">
      <h2 id="camionero-nombre">Bienvenido, Camionero</h2>
      <p>Selecciona tu cami√≥n y activa la ubicaci√≥n en tiempo real.</p>
      
      <div class="info-box">
        <strong>‚ÑπÔ∏è Importante:</strong> Tu ubicaci√≥n se compartir√° en tiempo real con los usuarios de la app. 
        Aseg√∫rate de seleccionar el cami√≥n correcto antes de activar.
      </div>

      <div class="form-group">
        <label for="select-camion">üöö Selecciona tu cami√≥n:</label>
        <select id="select-camion">
          <option value="">-- Seleccionar cami√≥n --</option>
          <option value="camionero1">üöõ Cami√≥n 1</option>
          <option value="camionero2">üöö Cami√≥n 2</option>
          <option value="camionero3">üöô Cami√≥n 3</option>
          <option value="camionero4">üöê Cami√≥n 4</option>
          <option value="camionero5">üöï Cami√≥n 5</option>
        </select>
      </div>

      <button id="btn-ubicacion" class="btn-toggle-ubicacion" data-tracking="false" disabled>
        Selecciona un cami√≥n primero
      </button>

      <div id="status" class="status">
        <strong>üìç Estado:</strong> <span id="status-text">Inactivo</span><br>
        <small id="coords-text"></small>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Proyecto Basurero. Todos los derechos reservados.</p>
  </footer>

  <script>
    // Cargar nombre del usuario si existe
    const usuario = JSON.parse(localStorage.getItem('usuarioActivo')||'{}');
    if (usuario.nombre) {
      document.getElementById('camionero-nombre').innerText = `Bienvenido, ${usuario.nombre}`;
    }

    const selectCamion = document.getElementById('select-camion');
    const btn = document.getElementById('btn-ubicacion');
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('status-text');
    const coordsText = document.getElementById('coords-text');
    let watchId = null;
    let camionActual = '';

    // Recuperar cami√≥n seleccionado previamente
    const camionGuardado = localStorage.getItem('camionSeleccionado');
    if (camionGuardado) {
      selectCamion.value = camionGuardado;
      camionActual = camionGuardado;
      btn.disabled = false;
      btn.textContent = 'Activar Ubicaci√≥n';
    }

    // Habilitar bot√≥n cuando se seleccione un cami√≥n
    selectCamion.addEventListener('change', (e) => {
      camionActual = e.target.value;
      
      if (camionActual) {
        // Guardar selecci√≥n
        localStorage.setItem('camionSeleccionado', camionActual);
        
        btn.disabled = false;
        btn.textContent = 'Activar Ubicaci√≥n';
        
        // Si estaba trackeando, detener
        if (btn.dataset.tracking === 'true') {
          detenerUbicacion();
        }
      } else {
        localStorage.removeItem('camionSeleccionado');
        btn.disabled = true;
        btn.textContent = 'Selecciona un cami√≥n primero';
      }
    });

    btn.addEventListener('click', () => {
      const tracking = btn.dataset.tracking === 'true';

      if (!tracking) {
        if (!camionActual) {
          return alert("‚ö†Ô∏è Por favor, selecciona un cami√≥n primero.");
        }
        iniciarUbicacion();
      } else {
        detenerUbicacion();
      }
    });

    function iniciarUbicacion() {
      if (!navigator.geolocation) {
        return alert("‚ùå Tu navegador no soporta geolocalizaci√≥n.");
      }

      console.log(`üìç Iniciando tracking para ${camionActual}`);

      // watchPosition pedir√° permiso solo la primera vez
      watchId = navigator.geolocation.watchPosition(pos => {
        const payload = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          timestamp: pos.timestamp,
          camionId: camionActual
        };
        
        db.ref(`ubicaciones/${camionActual}`).set(payload)
          .then(() => {
            console.log(`‚úÖ Ubicaci√≥n actualizada para ${camionActual}:`, payload);
            
            // Actualizar coordenadas en pantalla
            coordsText.textContent = `Lat: ${pos.coords.latitude.toFixed(6)}, Lng: ${pos.coords.longitude.toFixed(6)}`;
          })
          .catch(e => {
            console.error("‚ùå Error escribiendo en Firebase:", e);
            alert("Error al enviar ubicaci√≥n. Verifica tu conexi√≥n.");
          });
      }, err => {
        console.error("‚ùå watchPosition error:", err);
        alert("Error obteniendo ubicaci√≥n: " + err.message);
        detenerUbicacion();
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });

      btn.dataset.tracking = 'true';
      btn.textContent = 'Detener Ubicaci√≥n';
      btn.classList.add('active');
      selectCamion.disabled = true;
      
      statusDiv.classList.add('active');
      const camionTexto = selectCamion.options[selectCamion.selectedIndex].text;
      statusText.textContent = `Activo (${camionTexto})`;
      
      console.log(`üü¢ Tracking activado para ${camionActual}`);
    }

    function detenerUbicacion() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        console.log('‚è∏Ô∏è Watch position detenido');
      }
      
      if (keepAliveInterval !== null) {
        clearInterval(keepAliveInterval);
        keepAliveInterval = null;
        console.log('‚è∏Ô∏è Keep-alive detenido');
      }
      
      if (camionActual) {
        db.ref(`ubicaciones/${camionActual}`).remove()
          .then(() => {
            console.log(`üóëÔ∏è Ubicaci√≥n eliminada de Firebase para ${camionActual}`);
          })
          .catch(e => console.error("‚ùå Error borrando en Firebase:", e));
      }

      btn.dataset.tracking = 'false';
      btn.textContent = 'Activar Ubicaci√≥n';
      btn.classList.remove('active');
      selectCamion.disabled = false;
      
      statusDiv.classList.remove('active');
      statusText.textContent = 'Inactivo';
      coordsText.textContent = '';
      
      console.log('üî¥ Tracking detenido');
    }

    function logout() {
      console.log('üëã Cerrando sesi√≥n...');
      detenerUbicacion();
      localStorage.clear();
      window.location.href = 'login.html';
    }

    // Mantener la p√°gina activa incluso en segundo plano
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('üì± P√°gina en segundo plano - tracking contin√∫a');
      } else {
        console.log('üëÅÔ∏è P√°gina visible nuevamente');
        lastUpdate = Date.now(); // Resetear contador al volver
      }
    });

    // Detener tracking al cerrar/recargar p√°gina
    window.addEventListener('beforeunload', () => {
      if (watchId !== null && camionActual) {
        console.log('üö™ P√°gina cerr√°ndose, limpiando ubicaci√≥n...');
        db.ref(`ubicaciones/${camionActual}`).remove();
      }
    });

    // Auto-iniciar si estaba activo previamente (opcional)
    window.addEventListener('load', () => {
      console.log('üöÄ P√°gina cargada');
      console.log(`üì¶ Cami√≥n guardado: ${camionGuardado || 'ninguno'}`);
    });
  </script>
</body>
</html>