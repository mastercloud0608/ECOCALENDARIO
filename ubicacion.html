<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ubicaci√≥n en Tiempo Real - Debug</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
  />
  <style>
    #mapa-ubicacion {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      border: 2px solid #2ecc71;
    }

    /* Debug panel */
    .debug-panel {
      background: #f8f9fa;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 0.85em;
    }

    .debug-title {
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }

    .debug-info {
      background: white;
      padding: 8px;
      border-radius: 4px;
      margin: 5px 0;
      border-left: 3px solid #28a745;
    }

    .debug-warning {
      background: #fff3cd;
      border-left-color: #ffc107;
    }

    .debug-error {
      background: #f8d7da;
      border-left-color: #dc3545;
    }

    /* Estilos para el contenedor de notificaciones */
    #alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      max-width: 320px;
    }

    .notification-alert {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 15px;
      margin: 8px 0;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      border-left: 4px solid #2e7d32;
      animation: slideIn 0.4s ease-out;
      cursor: pointer;
    }

    .notification-alert.warning {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      border-left-color: #e65100;
    }

    .notification-alert.arrival {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      border-left-color: #0d47a1;
    }

    .notification-title {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }

    .notification-body {
      font-size: 0.9em;
      opacity: 0.95;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .notification-controls {
      background: #f5f5f5;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .notification-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-enabled {
      background: #4CAF50;
      color: white;
    }

    .status-disabled {
      background: #f44336;
      color: white;
    }

    .enable-notifications-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      margin-left: 10px;
    }

    .test-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="calendario.html">Calendario</a></li>
        <li><a href="noticias.html">Noticias</a></li>
        <li><a href="denuncias.html">Denuncias</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="welcome-section">
      <h2>Ubicaci√≥n en Tiempo Real - Debug Mode üîç</h2>
      <p>Visualiza en vivo la posici√≥n del cami√≥n de basura con informaci√≥n de depuraci√≥n.</p>
      
      <!-- Panel de control de notificaciones -->
      <div class="notification-controls">
        <span>üì± Notificaciones:</span>
        <span id="notification-status" class="notification-status status-disabled">Verificando...</span>
        <button id="enable-notifications" class="enable-notifications-btn">
          Habilitar Notificaciones
        </button>
        <button id="test-notification" class="test-btn">
          üß™ Probar Notificaci√≥n
        </button>
        <small style="display: block; margin-top: 8px; color: #666;">
          Recibe alertas cuando el cami√≥n se acerque a tu zona
        </small>
      </div>

      <!-- Panel de debug -->
      <div class="debug-panel">
        <div class="debug-title">üîç Informaci√≥n de Debug</div>
        <div id="debug-log"></div>
      </div>

      <div id="mapa-ubicacion"></div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Proyecto Basurero. Todos los derechos reservados.</p>
  </footer>

  <!-- Contenedor para notificaciones en pantalla -->
  <div id="alert-container"></div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>

  <script>
    // Sistema de debug
    class DebugLogger {
      constructor() {
        this.logContainer = document.getElementById('debug-log');
      }

      log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `debug-${type}`;
        logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
        this.logContainer.appendChild(logEntry);
        this.logContainer.scrollTop = this.logContainer.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      info(message) { this.log(message, 'info'); }
      warning(message) { this.log(message, 'warning'); }
      error(message) { this.log(message, 'error'); }
    }

    const debugLogger = new DebugLogger();

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAh5BW3Yg6pFNfDVynYXcHOiA96G5ZPr2w",
      authDomain: "ecocalendario-51a84.firebaseapp.com",
      databaseURL: "https://ecocalendario-51a84-default-rtdb.firebaseio.com",
      projectId: "ecocalendario-51a84",
      storageBucket: "ecocalendario-51a84.appspot.com",
      messagingSenderId: "276857323066",
      appId: "1:276857323066:web:99b3f8f2e9d0d471d97f03",
      measurementId: "G-VXCZYN6WNC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    debugLogger.info("Firebase inicializado correctamente");

    // Sistema de notificaciones mejorado con debug
    class NotificationSystem {
      constructor() {
        this.notified = new Set();
        this.RADIO_NOTIFICACION = 150; // metros
        this.RADIO_MUY_CERCA = 50; // metros
        this.isEnabled = false;
        this.initUI();
        this.checkBrowserSupport();
      }

      checkBrowserSupport() {
        if (!("Notification" in window)) {
          debugLogger.error("‚ùå Este navegador NO soporta notificaciones");
          return false;
        }
        debugLogger.info("‚úÖ Navegador soporta notificaciones");
        return true;
      }

      getRutaPoints() {
        return [
          {
            coords: [-17.7705396, -63.2099261],
            nombre: "Plaza Principal",
            zona: "Centro"
          },
          {
            coords: [-17.7720686, -63.2039419],
            nombre: "Mercado Municipal", 
            zona: "Zona Norte"
          },
          {
            coords: [-17.7773053, -63.2055378],
            nombre: "Barrio San Antonio",
            zona: "Zona Sur"
          },
          {
            coords: [-17.7774486, -63.2157215],
            nombre: "Terminal de Buses",
            zona: "Zona Este"
          }
        ];
      }

      initUI() {
        const statusEl = document.getElementById('notification-status');
        const enableBtn = document.getElementById('enable-notifications');
        const testBtn = document.getElementById('test-notification');
        
        // Verificar estado inicial
        this.updateNotificationStatus();
        
        // Bot√≥n para habilitar notificaciones
        enableBtn.addEventListener('click', () => {
          debugLogger.info("üëÜ Usuario hizo clic en 'Habilitar Notificaciones'");
          this.requestPermission();
        });

        // Bot√≥n de prueba
        testBtn.addEventListener('click', () => {
          debugLogger.info("üß™ Probando notificaci√≥n...");
          this.showNotification("üß™ Notificaci√≥n de Prueba", "¬°Las notificaciones est√°n funcionando!");
        });
      }

      async requestPermission() {
        debugLogger.info("üîî Solicitando permisos de notificaci√≥n...");
        
        if (!("Notification" in window)) {
          debugLogger.error("‚ùå Notificaciones no soportadas en este navegador");
          this.showAlert("‚ö†Ô∏è Notificaciones no soportadas", 
                        "Tu navegador no soporta notificaciones", "warning");
          return false;
        }

        debugLogger.info(`üìã Estado actual de permisos: ${Notification.permission}`);

        if (Notification.permission === "granted") {
          debugLogger.info("‚úÖ Permisos ya concedidos");
          this.isEnabled = true;
          this.updateNotificationStatus();
          this.showAlert("‚úÖ Notificaciones ya activas", 
                        "Las notificaciones ya estaban habilitadas", "arrival");
          return true;
        }

        if (Notification.permission === "denied") {
          debugLogger.error("‚ùå Permisos denegados por el usuario");
          this.showAlert("‚ùå Notificaciones bloqueadas", 
                        "Habilita las notificaciones en la configuraci√≥n del navegador", "warning");
          return false;
        }

        try {
          debugLogger.info("‚è≥ Esperando respuesta del usuario...");
          const permission = await Notification.requestPermission();
          debugLogger.info(`üìù Respuesta del usuario: ${permission}`);
          
          this.isEnabled = permission === "granted";
          this.updateNotificationStatus();
          
          if (this.isEnabled) {
            debugLogger.info("üéâ ¬°Notificaciones habilitadas con √©xito!");
            this.showAlert("‚úÖ Notificaciones activadas", 
                          "Ahora recibir√°s alertas del cami√≥n recolector", "arrival");
          } else {
            debugLogger.warning("‚ö†Ô∏è Usuario rechaz√≥ los permisos");
          }
          
          return this.isEnabled;
        } catch (error) {
          debugLogger.error(`üí• Error solicitando permisos: ${error.message}`);
          return false;
        }
      }

      updateNotificationStatus() {
        const statusEl = document.getElementById('notification-status');
        const enableBtn = document.getElementById('enable-notifications');
        
        if (Notification.permission === "granted") {
          statusEl.textContent = "Habilitadas";
          statusEl.className = "notification-status status-enabled";
          enableBtn.style.display = "none";
          this.isEnabled = true;
          debugLogger.info("üü¢ Estado UI: Notificaciones habilitadas");
        } else {
          statusEl.textContent = "Deshabilitadas";
          statusEl.className = "notification-status status-disabled";
          enableBtn.style.display = "inline-block";
          this.isEnabled = false;
          debugLogger.warning("üî¥ Estado UI: Notificaciones deshabilitadas");
        }
      }

      distancia(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + 
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
          Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      calcularTiempoEstimado(distanciaMetros) {
        const velocidadPromedio = 20 / 3.6; // 20 km/h en m/s
        const tiempoSegundos = distanciaMetros / velocidadPromedio;
        const minutos = Math.round(tiempoSegundos / 60);
        
        if (minutos < 1) return "menos de 1 minuto";
        if (minutos === 1) return "1 minuto";
        return `${minutos} minutos`;
      }

      showNotification(titulo, mensaje) {
        debugLogger.info(`üìß Intentando mostrar notificaci√≥n: "${titulo}"`);
        
        // Intentar notificaci√≥n del navegador
        if (this.isEnabled && Notification.permission === "granted") {
          try {
            const notification = new Notification(titulo, {
              body: mensaje,
              icon: "assets/images/camion.png",
              badge: "assets/images/badge.png",
              tag: "basurero-notif",
              requireInteraction: false,
              silent: false
            });

            debugLogger.info("üéØ Notificaci√≥n del navegador enviada exitosamente");

            setTimeout(() => notification.close(), 5000);
            
            notification.onclick = function() {
              debugLogger.info("üëÜ Usuario hizo clic en la notificaci√≥n");
              window.focus();
              this.close();
            };
          } catch (error) {
            debugLogger.error(`üí• Error creando notificaci√≥n: ${error.message}`);
          }
        } else {
          debugLogger.warning("‚ö†Ô∏è Notificaciones del navegador no disponibles, usando fallback");
        }
        
        // Siempre mostrar alerta en pantalla como backup
        this.showAlert(titulo, mensaje);
      }

      showAlert(titulo, mensaje, type = 'default') {
        debugLogger.info(`üí¨ Mostrando alerta en pantalla: "${titulo}"`);
        
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        
        let className = 'notification-alert';
        if (type === 'warning') className += ' warning';
        if (type === 'arrival') className += ' arrival';
        
        alert.className = className;
        alert.innerHTML = `
          <div class="notification-title">${titulo}</div>
          <div class="notification-body">${mensaje}</div>
        `;

        alert.addEventListener('click', () => {
          alert.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => alert.remove(), 300);
        });

        alertContainer.appendChild(alert);

        setTimeout(() => {
          if (alert.parentNode) {
            alert.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => alert.remove(), 300);
          }
        }, 5000);
      }

      checkProximity(lat, lng) {
        const puntos = this.getRutaPoints();
        debugLogger.info(`üìç Verificando proximidad en: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        
        puntos.forEach((punto, idx) => {
          const distanciaActual = this.distancia(lat, lng, punto.coords[0], punto.coords[1]);
          const puntoId = `punto-${idx}`;

          debugLogger.info(`üìè Distancia a ${punto.nombre}: ${Math.round(distanciaActual)}m`);

          // Notificaci√≥n de aproximaci√≥n (150m)
          if (distanciaActual <= this.RADIO_NOTIFICACION && !this.notified.has(puntoId)) {
            const tiempoEstimado = this.calcularTiempoEstimado(distanciaActual);
            
            debugLogger.info(`üîî ¬°DISPARANDO notificaci√≥n de aproximaci√≥n para ${punto.nombre}!`);
            
            this.showNotification(
              `üîî Cami√≥n Aproxim√°ndose`,
              `Se acerca a ${punto.nombre} (${punto.zona}) en aproximadamente ${tiempoEstimado}`
            );
            
            this.notified.add(puntoId);
          }

          // Notificaci√≥n de llegada (50m)
          if (distanciaActual <= this.RADIO_MUY_CERCA && !this.notified.has(`${puntoId}-llegada`)) {
            debugLogger.info(`üìç ¬°DISPARANDO notificaci√≥n de llegada para ${punto.nombre}!`);
            
            this.showNotification(
              `üìç Cami√≥n en el Punto`,
              `¬°El cami√≥n est√° en ${punto.nombre}! Es momento de sacar la basura`
            );
            this.notified.add(`${puntoId}-llegada`);
          }

          // Limpiar notificaciones si se aleja mucho
          if (distanciaActual > this.RADIO_NOTIFICACION * 2) {
            if (this.notified.has(puntoId) || this.notified.has(`${puntoId}-llegada`)) {
              debugLogger.info(`üßπ Limpiando notificaciones para ${punto.nombre}`);
              this.notified.delete(puntoId);
              this.notified.delete(`${puntoId}-llegada`);
            }
          }
        });
      }
    }

    // Inicializaci√≥n cuando la p√°gina carga
    window.addEventListener('DOMContentLoaded', () => {
      debugLogger.info("üöÄ Inicializando aplicaci√≥n...");
      
      // Inicializar sistema de notificaciones
      const notificationSystem = new NotificationSystem();
      
      // Definir la ruta
      const rutaCoords = [
        [-17.7705396, -63.2099261],
        [-17.7720686, -63.2039419],
        [-17.7773053, -63.2055378],
        [-17.7774486, -63.2157215]
      ];
      
      const rutaLine = turf.lineString(
        rutaCoords.map(([lat, lng]) => [lng, lat])
      );

      // Configuraci√≥n
      const ROUTE_THRESHOLD = 30;
      const IDLE_TIMEOUT_MS = 5000;

      // Inicializar mapa
      debugLogger.info("üó∫Ô∏è Inicializando mapa...");
      const map = L.map('mapa-ubicacion').setView(rutaCoords[0], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Dibujar ruta
      L.polyline(rutaCoords, { color:'red', weight:4, opacity:0.8 }).addTo(map);
      
      // Agregar marcadores de puntos con c√≠rculos de notificaci√≥n
      const puntos = notificationSystem.getRutaPoints();
      puntos.forEach((punto, i) => {
        // Marcador del punto
        L.marker(punto.coords).addTo(map)
          .bindPopup(`
            <strong>${punto.nombre}</strong><br>
            <em>${punto.zona}</em><br>
            <small>Punto ${i + 1} de la ruta</small>
          `);

        // C√≠rculo de notificaci√≥n
        L.circle(punto.coords, {
          color: 'orange',
          fillColor: '#ff7800',
          fillOpacity: 0.15,
          radius: 150
        }).addTo(map);
      });

      let marker = null;
      let idleTimer = null;
      let isFirstLocation = true;

      function showStationary(lat, lng) {
        const pt = turf.point([lng, lat]);
        const dist = turf.pointToLineDistance(pt, rutaLine, { units:'meters' });
        const text = dist <= ROUTE_THRESHOLD
          ? "üöö Cami√≥n en ruta"
          : "‚ö†Ô∏è Fuera de ruta";
        if (marker) {
          marker.getPopup().setContent(text);
          marker.openPopup();
        }
      }

      // Suscripci√≥n a Firebase con notificaciones
      debugLogger.info("üì° Conectando con Firebase...");
      
      db.ref('ubicaciones/camionero1').on('value', snap => {
        debugLogger.info("üì® Recibidos datos de Firebase");
        
        const d = snap.val();
        if (!d || typeof d.lat !== 'number' || typeof d.lng !== 'number') {
          debugLogger.warning("‚ö†Ô∏è Datos inv√°lidos recibidos de Firebase");
          if (marker) {
            map.removeLayer(marker);
            marker = null;
          }
          return;
        }
        
        const { lat, lng } = d;
        debugLogger.info(`üìç Nueva posici√≥n recibida: ${lat}, ${lng}`);

        // Verificar proximidad para notificaciones
        notificationSystem.checkProximity(lat, lng);

        // Crear marcador la primera vez
        if (!marker) {
          marker = L.marker([lat, lng], {
            icon: L.icon({
              iconUrl: 'assets/images/camion.png',
              iconSize: [35,35],
              iconAnchor: [17,35]
            })
          }).addTo(map).bindPopup("");
          
          // Notificaci√≥n inicial
          if (isFirstLocation) {
            debugLogger.info("üöõ Primera ubicaci√≥n recibida, enviando notificaci√≥n inicial");
            notificationSystem.showNotification(
              "üöõ Cami√≥n en Ruta",
              "El cami√≥n recolector ha iniciado su recorrido"
            );
            isFirstLocation = false;
          }
        }

        // Actualizar posici√≥n
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 15);

        // Mostrar estado en movimiento
        marker.getPopup().setContent("üöö Cami√≥n en movimiento");
        marker.openPopup();

        // Reiniciar temporizador para estado estacionario
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
          showStationary(lat, lng);
        }, IDLE_TIMEOUT_MS);
      }, err => {
        debugLogger.error(`üí• Error leyendo Firebase: ${err.message}`);
      });

      debugLogger.info("‚úÖ Aplicaci√≥n inicializada correctamente");
    });
  </script>
</body>
</html>