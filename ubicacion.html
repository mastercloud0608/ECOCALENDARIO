<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ubicaci√≥n en Tiempo Real</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
  />
  <style>
    #mapa-ubicacion { width: 100%; height: 400px; border-radius: 8px; }
  </style>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>
  <script>
    // Config Firebase (igual que en camionero.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAh5BW3Yg6pFNfDVynYXcHOiA96G5ZPr2w",
      authDomain: "ecocalendario-51a84.firebaseapp.com",
      databaseURL: "https://ecocalendario-51a84-default-rtdb.firebaseio.com",
      projectId: "ecocalendario-51a84",
      storageBucket: "ecocalendario-51a84.appspot.com",
      messagingSenderId: "276857323066",
      appId: "1:276857323066:web:99b3f8f2e9d0d471d97f03",
      measurementId: "G-VXCZYN6WNC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="calendario.html">Calendario</a></li>
        <li><a href="noticias.html">Noticias</a></li>
        <li><a href="denuncias.html">Denuncias</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="welcome-section">
      <h2>Ubicaci√≥n en Tiempo Real</h2>
      <p>
        Visualiza en vivo la posici√≥n del cami√≥n de basura.
      </p>
      <div id="mapa-ubicacion"></div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Proyecto Basurero. Todos los derechos reservados.</p>
  </footer>

  <script>
    // puntos de la ruta (opcional, para fondo de mapa)
    const ruta = [
      [-17.7705396, -63.2099261],
      [-17.7720686, -63.2039419],
      [-17.7773053, -63.2055378],
      [-17.7774486, -63.2157215]
    ];

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI/180;
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2
              + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))
              * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function mostrarNotificacion(msg) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification(msg);
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(p => {
          if (p === "granted") new Notification(msg);
        });
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      // 1) inicializar mapa
      const map = L.map('mapa-ubicacion').setView([-17.7850,-63.1737],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'¬© OpenStreetMap contributors'
      }).addTo(map);

      // 2) dibujar ruta de fondo (opcional)
      const poly = L.polyline(ruta,{ color:'red', weight:4 }).addTo(map);
      map.fitBounds(poly.getBounds());

      let marker = null;
      let lastPos = null;
      let isMoving = false;
      const notified = new Set();

      // 3) escucha la RTDB
      db.ref('ubicaciones/camionero1')
        .on('value', snap => {
          const d = snap.val();
          if (!d || !d.lat || !d.lng) {
            if (marker) { map.removeLayer(marker); marker = null; }
            return;
          }
          const pos = [d.lat, d.lng];

          if (!marker) {
            // primera vez: estado ‚Äúruta‚Äù
            marker = L.marker(pos, {
              icon: L.icon({
                iconUrl: 'assets/images/camion.png',
                iconSize: [25,25],
                iconAnchor: [12,25]
              })
            }).addTo(map)
              .bindPopup("üöö Cami√≥n en ruta")
              .openPopup();
            isMoving = false;
            lastPos = pos;

          } else {
            // medimos desplazamiento
            const dist = calcularDistancia(
              lastPos[0], lastPos[1],
              pos[0], pos[1]
            );
            if (dist > 10 && !isMoving) {
              isMoving = true;
              marker.getPopup()
                .setContent("üöö Cami√≥n en movimiento")
                .openOn(map);
            } else if (dist <= 10 && isMoving) {
              isMoving = false;
              marker.getPopup()
                .setContent("üöö Cami√≥n en ruta")
                .openOn(map);
            }
            marker.setLatLng(pos);
            lastPos = pos;
          }

          map.setView(pos, 15);

          // notificaciones cerca de cada punto
          ruta.forEach((p,i) => {
            if (notified.has(i)) return;
            const d2 = calcularDistancia(d.lat,d.lng,p[0],p[1]);
            if (d2 < 100) {
              mostrarNotificacion(`üìç Cami√≥n cerca del Punto ${i+1}`);
              notified.add(i);
            }
          });
        }, err => console.error("Firebase read error:", err));
    });
  </script>
</body>
</html>
