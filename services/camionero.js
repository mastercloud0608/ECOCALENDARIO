// services/camionero.js - VERSI√ìN CORREGIDA

// Verificar login
if (localStorage.getItem('loggedIn') !== 'true') {
    window.location.href = 'login.html';
}

// Inicializar Firebase (debe estar cargado en el HTML)
let db;
try {
    db = firebase.database();
    console.log('‚úÖ Firebase inicializado correctamente');
} catch (error) {
    console.error('‚ùå Error inicializando Firebase:', error);
}

let map, userMarker;
let watchId = null;
let tracking = false;
let camionActual = '';
let lastUpdate = Date.now();
let keepAliveInterval = null;

window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btn-ubicacion');
    const selectCamion = document.getElementById('select-camion');
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('status-text');
    const coordsText = document.getElementById('coords-text');

    // Cargar nombre del usuario si existe
    const usuario = JSON.parse(localStorage.getItem('usuarioActivo') || '{}');
    const nombreElement = document.getElementById('camionero-nombre');
    if (usuario.nombre && nombreElement) {
        nombreElement.innerText = `Bienvenido, ${usuario.nombre}`;
    }

    // Recuperar cami√≥n seleccionado previamente
    const camionGuardado = localStorage.getItem('camionSeleccionado');
    if (camionGuardado && selectCamion) {
        selectCamion.value = camionGuardado;
        camionActual = camionGuardado;
        btn.disabled = false;
        btn.textContent = 'Activar Ubicaci√≥n';
        console.log(`üì¶ [${camionGuardado}] Cami√≥n restaurado desde localStorage`);
    }

    // Recuperar estado de tracking
    const ubicacionActiva = localStorage.getItem('ubicacionActiva') === 'true';
    if (ubicacionActiva && camionActual) {
        console.log(`üîÑ [${camionActual}] Restaurando sesi√≥n de tracking...`);
        iniciarSeguimiento();
    }

    // Event listener para selector de cami√≥n
    if (selectCamion) {
        selectCamion.addEventListener('change', (e) => {
            const camionAnterior = camionActual;
            camionActual = e.target.value;
            
            if (camionActual) {
                // Guardar selecci√≥n
                localStorage.setItem('camionSeleccionado', camionActual);
                console.log(`üîÑ Cami√≥n cambiado: ${camionAnterior || 'ninguno'} ‚Üí ${camionActual}`);
                
                btn.disabled = false;
                btn.textContent = 'Activar Ubicaci√≥n';
                
                // Si estaba trackeando, detener
                if (tracking) {
                    detenerSeguimiento();
                }
            } else {
                localStorage.removeItem('camionSeleccionado');
                btn.disabled = true;
                btn.textContent = 'Selecciona un cami√≥n primero';
                console.log('‚ö†Ô∏è Cami√≥n deseleccionado');
            }
        });
    }

    // Event listener para bot√≥n de ubicaci√≥n
    if (btn) {
        btn.addEventListener('click', () => {
            if (!tracking) {
                solicitarPermisoYIniciar();
            } else {
                detenerSeguimiento();
            }
        });
    }

    function solicitarPermisoYIniciar() {
        if (!camionActual) {
            alert("‚ö†Ô∏è Por favor, selecciona un cami√≥n primero.");
            return;
        }

        if (!navigator.geolocation) {
            alert("‚ùå La geolocalizaci√≥n no es soportada por este navegador.");
            return;
        }

        // Verificar si ya se dio permiso antes
        const permisoGuardado = localStorage.getItem('gpsPermisoOtorgado');
        
        if (permisoGuardado === 'true') {
            console.log(`‚úÖ [${camionActual}] Permiso previamente otorgado, iniciando...`);
            iniciarSeguimiento();
            return;
        }

        // Verificar permiso del navegador
        if (navigator.permissions) {
            navigator.permissions.query({ name: 'geolocation' }).then(result => {
                if (result.state === 'granted') {
                    console.log(`‚úÖ [${camionActual}] Permiso ya otorgado`);
                    localStorage.setItem('gpsPermisoOtorgado', 'true');
                    iniciarSeguimiento();
                } else if (result.state === 'prompt') {
                    console.log(`‚ùì [${camionActual}] Solicitando permiso...`);
                    iniciarSeguimiento();
                } else {
                    alert('‚ö†Ô∏è Permisos de ubicaci√≥n bloqueados.\n\nToca el candado üîí y permite "Ubicaci√≥n"');
                }
            }).catch(err => {
                console.warn(`‚ö†Ô∏è [${camionActual}] API de permisos no disponible`);
                iniciarSeguimiento();
            });
        } else {
            iniciarSeguimiento();
        }
    }

    function iniciarSeguimiento() {
        if (!camionActual) {
            console.error('‚ùå No hay cami√≥n seleccionado');
            return;
        }

        tracking = true;
        btn.classList.add('active');
        btn.textContent = 'Detener Ubicaci√≥n';
        btn.style.backgroundColor = '#f44336';
        localStorage.setItem('ubicacionActiva', 'true');

        if (selectCamion) {
            selectCamion.disabled = true;
        }

        if (statusDiv) {
            statusDiv.classList.add('active');
        }
        
        if (statusText && selectCamion) {
            const camionTexto = selectCamion.options[selectCamion.selectedIndex].text;
            statusText.textContent = `Activo (${camionTexto})`;
        }

        // Inicializar mapa si existe el contenedor
        inicializarMapa();

        console.log(`üü¢ [${camionActual}] Iniciando tracking...`);

        // Watchposition para actualizaci√≥n continua
        watchId = navigator.geolocation.watchPosition(position => {
            const { latitude, longitude, accuracy } = position.coords;

            // CR√çTICO: Usar timestamp consistente
            const timestamp = Date.now();

            const payload = {
                lat: latitude,
                lng: longitude,
                accuracy: accuracy,
                timestamp: timestamp,
                camionId: camionActual
            };

            lastUpdate = timestamp;

            // IMPORTANTE: Escribir en la ruta espec√≠fica del cami√≥n
            if (db) {
                db.ref(`ubicaciones/${camionActual}`).set(payload)
                    .then(() => {
                        console.log(`‚úÖ [${camionActual}] Ubicaci√≥n actualizada:`, {
                            lat: latitude.toFixed(6),
                            lng: longitude.toFixed(6),
                            timestamp: new Date(timestamp).toLocaleTimeString()
                        });
                        
                        if (coordsText) {
                            coordsText.textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)} | Precisi√≥n: ${Math.round(accuracy)}m`;
                        }
                    })
                    .catch(error => {
                        console.error(`‚ùå [${camionActual}] Error enviando a Firebase:`, error);
                    });
            }

            // Guardar en localStorage como backup
            const ubicacionBackup = {
                lat: latitude,
                lng: longitude,
                timestamp: timestamp,
                accuracy: accuracy,
                camionId: camionActual
            };
            localStorage.setItem('camioneroUbicacion', JSON.stringify(ubicacionBackup));

            // Actualizar mapa si est√° inicializado
            actualizarMapa(latitude, longitude);

        }, error => {
            console.error(`‚ùå [${camionActual}] Error durante seguimiento:`, error.message);
            
            if (error.code === error.PERMISSION_DENIED) {
                alert("‚ö†Ô∏è Permiso de ubicaci√≥n denegado.\n\nPara usar esta funci√≥n:\n1. Toca el candado üîí en la barra de direcciones\n2. Permite 'Ubicaci√≥n' para este sitio\n3. Recarga la p√°gina");
                detenerSeguimiento();
            } else {
                console.warn(`‚ö†Ô∏è [${camionActual}] Error temporal, continuando...`);
            }
        }, {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 27000
        });

        // Sistema keep-alive
        keepAliveInterval = setInterval(() => {
            const timeSinceUpdate = Date.now() - lastUpdate;
            
            if (timeSinceUpdate > 30000) {
                console.warn(`‚ö†Ô∏è [${camionActual}] Sin actualizaciones por ${Math.round(timeSinceUpdate/1000)}s, reiniciando...`);
                
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                }
                
                // Reiniciar sin cambiar UI
                watchId = navigator.geolocation.watchPosition(position => {
                    const timestamp = Date.now();
                    const payload = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: timestamp,
                        camionId: camionActual
                    };
                    
                    lastUpdate = timestamp;
                    
                    if (db) {
                        db.ref(`ubicaciones/${camionActual}`).set(payload)
                            .then(() => console.log(`‚úÖ [${camionActual}] Ubicaci√≥n actualizada (reinicio)`))
                            .catch(e => console.error(`‚ùå [${camionActual}] Error:`, e));
                    }
                    
                    actualizarMapa(position.coords.latitude, position.coords.longitude);
                }, err => {
                    console.warn(`‚ö†Ô∏è [${camionActual}] Error:`, err.message);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                });
            }
            
            console.log(`üíö [${camionActual}] Keep-alive: √∫ltima actualizaci√≥n hace ${Math.round(timeSinceUpdate/1000)}s`);
        }, 10000);

        console.log(`üì° [${camionActual}] WatchPosition iniciado con ID: ${watchId}`);
    }

    function detenerSeguimiento() {
        console.log(`üõë [${camionActual}] Deteniendo seguimiento...`);

        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            console.log(`‚è∏Ô∏è [${camionActual}] WatchPosition detenido`);
        }

        if (keepAliveInterval !== null) {
            clearInterval(keepAliveInterval);
            keepAliveInterval = null;
            console.log(`‚è∏Ô∏è [${camionActual}] Keep-alive detenido`);
        }

        // CR√çTICO: Eliminar solo la ubicaci√≥n de ESTE cami√≥n
        if (db && camionActual) {
            db.ref(`ubicaciones/${camionActual}`).remove()
                .then(() => {
                    console.log(`üóëÔ∏è [${camionActual}] Ubicaci√≥n eliminada de Firebase`);
                })
                .catch(error => {
                    console.error(`‚ùå [${camionActual}] Error eliminando de Firebase:`, error);
                });
        }

        tracking = false;
        btn.classList.remove('active');
        btn.textContent = 'Activar Ubicaci√≥n';
        btn.style.backgroundColor = '#4CAF50';

        if (selectCamion) {
            selectCamion.disabled = false;
        }

        if (statusDiv) {
            statusDiv.classList.remove('active');
        }

        if (statusText) {
            statusText.textContent = 'Inactivo';
        }

        if (coordsText) {
            coordsText.textContent = '';
        }

        localStorage.removeItem('camioneroUbicacion');
        localStorage.setItem('ubicacionActiva', 'false');

        console.log(`üî¥ [${camionActual}] Tracking detenido completamente`);
    }

    function inicializarMapa() {
        const mapaContenedor = document.getElementById('mapa-ubicacion');
        
        // Solo inicializar si existe el contenedor y no est√° ya inicializado
        if (!mapaContenedor || map) return;

        console.log(`üó∫Ô∏è [${camionActual}] Inicializando mapa...`);

        map = L.map('mapa-ubicacion').setView([-17.7850, -63.1737], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        console.log(`‚úÖ [${camionActual}] Mapa inicializado`);
    }

    function actualizarMapa(lat, lng) {
        if (!map) return;

        const pos = [lat, lng];

        if (!userMarker) {
            userMarker = L.marker(pos, {
                title: `${camionActual} - Tu ubicaci√≥n`,
                icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map).bindPopup(`üìç ${camionActual}`).openPopup();
        } else {
            userMarker.setLatLng(pos);
        }

        map.setView(pos, 16);
    }
});

// Funci√≥n de logout
function logout() {
    const camionActual = localStorage.getItem('camionSeleccionado') || '';
    console.log(`üëã [${camionActual}] Cerrando sesi√≥n...`);
    
    // Detener tracking si est√° activo
    if (watchId !== null && camionActual && db) {
        navigator.geolocation.clearWatch(watchId);
        db.ref(`ubicaciones/${camionActual}`).remove()
            .then(() => console.log(`üóëÔ∏è [${camionActual}] Ubicaci√≥n limpiada al cerrar sesi√≥n`))
            .catch(e => console.error(`‚ùå [${camionActual}] Error limpiando ubicaci√≥n:`, e));
    }

    // Limpiar localStorage
    localStorage.removeItem('loggedIn');
    localStorage.removeItem('camioneroUbicacion');
    localStorage.removeItem('ubicacionActiva');
    localStorage.removeItem('camionSeleccionado');
    localStorage.removeItem('usuarioActivo');
    
    // Redirigir a login
    window.location.href = 'login.html';
}

// Limpiar ubicaci√≥n al cerrar/recargar la p√°gina
window.addEventListener('beforeunload', () => {
    const camionActual = localStorage.getItem('camionSeleccionado') || '';
    
    if (watchId !== null && camionActual && db) {
        console.log(`üö™ [${camionActual}] P√°gina cerr√°ndose, limpiando ubicaci√≥n...`);
        
        // Uso de sendBeacon para env√≠o garantizado al cerrar
        const url = `https://ecocalendario-51a84-default-rtdb.firebaseio.com/ubicaciones/${camionActual}.json`;
        navigator.sendBeacon(url, JSON.stringify(null));
    }
});

// Detectar cambios de visibilidad de la p√°gina
document.addEventListener('visibilitychange', () => {
    const camionActual = localStorage.getItem('camionSeleccionado') || '';
    
    if (document.hidden) {
        console.log(`üì± [${camionActual}] P√°gina en segundo plano - tracking contin√∫a`);
    } else {
        console.log(`üëÅÔ∏è [${camionActual}] P√°gina visible nuevamente`);
        lastUpdate = Date.now(); // Resetear contador
    }
});